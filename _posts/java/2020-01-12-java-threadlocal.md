---
layout: post
title:  "Java ThreadLocal"
date:   2020-01-12 20:33:00
author: bghgu
categories: JAVA
tags: [JAVA]
---

#### ThreadLocal 스레드 로컬
* 오직 한 스레드에 의해 읽고 쓰여질 수 있는 변수를 생성할 수 있도록 한다.
* 만일 두 스레드가 같은 코드를 실행하고 이 코드가 하나의 스레드로컬 변수를 참조하더라도, 이 두 스레드는 서로의 스레드로컬 변수를 볼 수 없다.
* 스레드의 지역변수이다.
* 스레드로컬 변수에 보관된 데이터의 사용이 끝나면 반드시 해당 데이터를 삭제해 주어야 한다.
* 재사용되는 스레드가 올바르지 않은 데이터를 참조할 수 있다.
* static한 객체한테 스레드별로 같은 스레드 안에서는 값을 유지해준다.
* 동일한 스레드라면 파라미터로 넘기지 않아도 값을 꺼낼 수 있다.
* 스레드로컬을 사용하려면 static으로 사용한다. static이 아니면 매번 필드가 메모리에 만들어진다.
* RequestContextHolder는 내부적으로 ThreadLocal이 구현되어 있다.
* 스레드로컬 사용시 인자로 넘겨야할 값을 스레드로컬을 통해 넘겨 줌으로써 눈에 보이지 않는 연결관계를 만들어내고 이에 그 스레드로컬 생성 로직에 의존성을 갖게 된다.
* 전역변수 아닌 전역변수
* ThreadLocal을 사용한다면 다른 모듈을 수정할 필요 없이(파라미터 추가가 필요 없다는 걸 강조합니다.) 다양한 요구 사항에 적은 비용없이 구현할 수 있다.

#### 스레드로컬 사용 예
1. 사용자 인증정보 전파 : Spring Security에서는 스레드로컬을 이용해서 사용자 인증 정보를 전파한다.
2. 트랜잭션 컨텍스트 전파 : 트랜잭션 매니저는 트랜잭션 컨텍스트를 전파하는데 스레드로컬을 사용한다.
3. 스레드에 안전해야 하는 데이터 보관